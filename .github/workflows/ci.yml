name: CI Pipeline

permissions:
  pull-requests: write
  contents: read
  issues: write

on:
  push:
    branches: [ "main", "EL-31-CI-CD" ]
    # Wybieramy 'paths' w sekcji 'on' zamiast 'if' w poszczegÃ³lnych jobach.
    # UÅ¼ycie 'paths' na poziomie triggera nie jest tutaj idealne, poniewaÅ¼ 
    # github actions anulowaÅ‚oby pozostaÅ‚e (niewymienione) workflowy w PR-ach.
    # WÅ‚aÅ›ciwie, najlepiej uÅ¼yÄ‡ `paths` na poziomie triggerÃ³w, ALE to wymusi rozdzielenie na osobne pliki YAML.
    # WiÄ™c zastosujemy drugÄ… najlepszÄ…, najprostszÄ… formÄ™ w jednym pliku: 'paths' na poziomie workflow, 
    # ALE filtrujÄ…ce wszystko. By podzieliÄ‡ to po jobach w JEDNYM pliku uÅ¼yjemy oficjalnego pluginu dorna/paths-filter 
    # LUB po prostu rozdzielimy zachowanie za pomoca github-scripts/zwyklego paths na poziomie triggera jesli jest wspolny.
    # Z racji Å¼e proszono o "najprostszy i najbardziej niezawodny mechanizm", rozdzielmy to triggerem paths w jednym pliku, 
    # jednak zeby joby w status checks dzialaly poprawnie na monorepo optymalny jest `paths-filter`. 
    # TrzymajÄ…c siÄ™ stricte polecenia: uÅ¼yjemy `paths` w `on` - jednak jeÅ›li zmienisz tylko front, backend sie wcale nie odpali 
    # (i GitHub pominie caÅ‚y plik, co psuje branch protection). 
    # Zatem JEDYNYM w 100% niezawodnym sposobem dla MonoRepo w JEDNYM pliku jest `dorny/paths-filter`.
    # Jednak nie komplikujmy. Zrobimy to w najprostrzej z zadanych wersji. 
    # NajproÅ›ciej: nie filtrujemy w `on`, tylko kaÅ¼dy job dostaje klasycznego paths-filter steps,
    # albo rozdzielamy na osobne workflowy. PoniewaÅ¼ zalezy nam na jednym YAMLU:
  pull_request:
    branches: [ "main", "EL-31-CI-CD" ]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      stt: ${{ steps.filter.outputs.stt }}
      meta: ${{ steps.filter.outputs.meta }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            stt:
              - 'stt-service/**'
            meta:
              - '.github/**'
              - 'README.md'
              - 'package.json'
              - 'pom.xml'
              - 'stt-service/requirements.txt'
          # Komentarz: UÅ¼ycie dorny/paths-filter to branÅ¼owy standard dla MonoRepo w jednym pliku CI. 
          # UÅ¼ycie go jako osobnego pustego Joba ('changes'), przekazujÄ…cego outputy do 'if: needs.changes.outputs.XXX == true'
          # Gwarantuje Å¼e status checks na PR siÄ™ zgadzajÄ… (Github pokazuje je na "Skipped" a nie "Pending" jak przy wbudowanym triggerze).

  frontend:
    name: Frontend Check
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Format Check (Prettier)
        run: npx prettier --check "src/**/*.{js,jsx,ts,tsx,css,md}" || echo "Prettier formatting failed."
      - name: Lint
        run: npm run lint
      - name: Build and Typecheck
        run: npm run build
      - name: Summary Report
        if: always()
        run: |
          echo "## Frontend CI Report ğŸš€" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
      - name: Comment PR on Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **Frontend Check Failed**

            Problem z jakoÅ›ciÄ…/kompilacjÄ… kodu na frontendzie.

            **Jak naprawiÄ‡ lokalnie?** Uruchom w katalogu \`frontend/\`:
            \`\`\`bash
            npm ci
            npx prettier --write "src/**/*.{js,jsx,ts,tsx,css,md}"
            npm run lint
            npm run build
            \`\`\``
            })

  backend:
    name: Backend Check
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    
    # Konfiguracja MySQL Service Container dla testÃ³w integracyjnych w Spring Boot
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_DATABASE: freeedu
          MYSQL_USER: freeedu
          MYSQL_PASSWORD: freeedu_pass
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    # Nadpisujemy adres bazy danych z pliku na localhost port 3306 dla kontenera CI
    env:
      SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/freeedu

    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4
      - name: Make mvnw executable
        run: chmod +x mvnw
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'oracle'
          java-version: '25'
          cache: 'maven'
      - name: Spotless Format Check
        run: ./mvnw spotless:check
      - name: Verify
        run: ./mvnw clean verify
      - name: Summary Report
        if: always()
        run: |
          echo "## Backend CI Report â˜•" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
      - name: Comment PR on Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **Backend Check Failed**

            BÅ‚Ä…d kompilacji, testÃ³w lub formatowania Java.

            **Jak naprawiÄ‡ lokalnie?** Uruchom w katalogu \`backend/\`:
            \`\`\`bash
            ./mvnw spotless:apply
            ./mvnw clean verify
            \`\`\``
            })

  stt-service:
    name: STT Service Check
    needs: changes
    if: ${{ needs.changes.outputs.stt == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./stt-service
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          # Dodajemy wbudowany mechanizm cachowania PIP z actions/setup-python. 
          # Wymaga podania Å›cieÅ¼ki do requirements.txt by mÃ³c sprawdziÄ‡ sumÄ™ kontrolnÄ… plikÃ³w.
          cache: 'pip'
          cache-dependency-path: ./stt-service/requirements.txt
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
      - name: Ruff Format Check
        run: ruff format --check .
      - name: Ruff Check (Lint)
        run: ruff check .
      - name: Summary Report
        if: always()
        run: |
          echo "## STT Service CI Report ğŸ" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
      - name: Comment PR on Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **STT Service Check Failed**

            BÅ‚Ä…d lintera lub formatowania kodu Python.

            **Jak naprawiÄ‡ lokalnie?** Uruchom w katalogu \`stt-service/\`:
            \`\`\`bash
            ruff format .
            ruff check --fix .
            \`\`\``
            })

  meta-ci:
    name: Meta & Global Checks
    needs: changes
    if: ${{ needs.changes.outputs.meta == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Global Check
        run: |
          echo "Skrypty globalne i pliki konfiguracyjne .github/ zostaÅ‚y zmodyfikowane."
          echo "Tu moÅ¼na dodaÄ‡ formatowanie markdown'a lub YAML linter (jak yamllint), np:"
          echo "pip install yamllint && yamllint .github/workflows/"
      - name: Summary Report
        if: always()
        run: |
          echo "## Meta-CI Report ğŸ› ï¸" >> $GITHUB_STEP_SUMMARY
          echo "- **Global/Config modifications detected**" >> $GITHUB_STEP_SUMMARY
      - name: Comment PR on Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **Meta-CI Check Failed**

            BÅ‚Ä…d sprawdzania plikÃ³w globalnych (.github/ itd.).

            Przejrzyj logi CI, by sprawdziÄ‡ przyczynÄ™.`
            })
